{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Lista de Registros</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { font-family:'Rubik',sans-serif; background:#fff3e0; margin:0; padding:0; color:#333; }
header { background:#ff9800; color:white; text-align:center; padding:20px 0; font-size:2em; box-shadow:0 4px 6px rgba(0,0,0,0.2);}
.logo{width:120px;margin-bottom:10px}
.container{padding:20px;display:flex;flex-direction:column;align-items:center}
#map{height:500px;width:100%;max-width:1200px;border-radius:12px;margin-bottom:20px}
.table-responsive{width:100%;overflow-x:auto}
table{width:100%;min-width:900px;margin-top:20px;border-collapse:collapse;background:#fff;box-shadow:0 8px 16px rgba(0,0,0,0.15)}
th,td{padding:10px;text-align:center;border:1px solid #ddd; cursor: pointer;}
th{background:#ff9800;color:#fff}
tr:nth-child(even){background:#f9f9f9}
.btn{padding:10px 20px;font-size:0.9em;margin:2px;cursor:pointer;border:none;border-radius:20px;background:#fb8c00;color:#fff; display:inline-block;}
.btn-danger{background:red}
footer{text-align:center;padding:20px;background:#333;color:#fff;font-size:0.9em}
input[type="text"], input[type="date"]{padding:6px 8px; width:120px; border-radius:6px; border:1px solid #ccc;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
.modal-content{background:white;padding:20px;border-radius:12px;min-width:300px;max-width:600px;position:relative;}
.modal-close{position:absolute;top:10px;right:10px;cursor:pointer;font-weight:bold;}
.toast{position:fixed;bottom:20px;right:20px;padding:15px 25px;background:#333;color:white;border-radius:8px;display:none;z-index:1000;}
#searchInput{margin-bottom:15px;padding:6px 8px;width:250px;border-radius:6px;border:1px solid #ccc;}
.pagination{margin:10px 0; display:flex; justify-content:center; gap:5px;}
.pagination button{padding:6px 12px; border-radius:5px; border:1px solid #ccc; background:#fb8c00; color:#fff; cursor:pointer;}
.pagination button.active{background:#f57c00;}
</style>
</head>
<body>
<header>
  <div>
    <img src="https://www.prefeitura.sp.gov.br/cidade/secretarias/upload/comunicacao/noticias/defesacivil.jpg" alt="Logo Defesa Civil São Paulo" class="logo">
  </div>
  Lista de Registros
</header>

<div class="container">
  <!-- Mapa -->
  <div id="map"></div>

  <!-- Filtro rápido -->
  <input type="text" id="searchInput" placeholder="Pesquisar na tabela...">

  <div class="table-responsive">
    <table id="ocorrenciasTable">
      <thead>
        <tr>
          <th data-column="numero">FOC N.º</th>
          <th data-column="sigrc">SIGRC N.º</th>
          <th data-column="endereco">Endereço</th>
          <th data-column="bairro">Bairro</th>
          <th data-column="distrito">Distrito</th>
          <th data-column="area_risco">Área de Risco</th>
          <th data-column="motivo">Motivo</th>
          <th data-column="data">Data</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for ocorrencia in ocorrencias %}
        <tr data-id="{{ ocorrencia.id }}">
          <td>{{ ocorrencia.numero }}</td>
          <td>{{ ocorrencia.sigrc }}</td>
          <td>{{ ocorrencia.endereco }}</td>
          <td>{{ ocorrencia.bairro }}</td>
          <td>{{ ocorrencia.distrito }}</td>
          <td>{{ ocorrencia.area_risco }}</td>
          <td>{{ ocorrencia.motivo }}</td>
          <td>{{ ocorrencia.data|date:'d/m/Y' }}</td>
          <td>
            <button class="btn editBtn">Editar</button>
            <a href="{% url 'excluir_ocorrencia' ocorrencia.id %}" class="btn btn-danger" onclick="return confirm('Deseja excluir?')">Excluir</a>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="9">Nenhuma ocorrência registrada.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Paginação -->
  <div class="pagination" id="pagination"></div>

  <a href="{% url 'home' %}" class="btn">VOLTAR</a>
</div>

<!-- Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <h3>Editar Ocorrência</h3>
    <form id="editForm" method="post">
      {% csrf_token %}
      <label>FOC N.º</label><br><input type="text" name="numero"><br>
      <label>SIGRC N.º</label><br><input type="text" name="sigrc"><br>
      <label>Endereço</label><br><input type="text" name="endereco"><br>
      <label>Bairro</label><br><input type="text" name="bairro"><br>
      <label>Distrito</label><br><input type="text" name="distrito"><br>
      <label>Área de Risco</label><br><input type="text" name="area_risco"><br>
      <label>Motivo</label><br><input type="text" name="motivo"><br>
      <label>Data</label><br><input type="date" name="data"><br><br>
      <button type="submit" class="btn">Salvar</button>
    </form>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // Mapa
  var map = L.map('map').setView([-23.682, -46.875], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap contributors'}).addTo(map);
  var coresRisco = {"0":"green","1":"yellow","2":"orange","3":"red","4":"darkred"};
  var marcadores = [];
  var ocorrenciasData = [
    {% for oc in ocorrencias %}
    {
      id: {{ oc.id }},
      endereco: "{{ oc.endereco|escapejs }}",
      motivo: "{{ oc.motivo|escapejs }}",
      area_risco: "{{ oc.area_risco }}",
      lat: "{{ oc.latitude }}",
      lon: "{{ oc.longitude }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  ocorrenciasData.forEach(function(oc){
    var lat=parseFloat(oc.lat.replace(',', '.'));
    var lon=parseFloat(oc.lon.replace(',', '.'));
    if(isFinite(lat)&&isFinite(lon)){
      var cor=coresRisco[oc.area_risco]||"blue";
      var marker=L.circleMarker([lat,lon],{color:cor,radius:8,fillOpacity:0.9,weight:1}).addTo(map);
      marker.bindPopup("<strong>"+oc.endereco+"</strong><br>"+oc.motivo+"<br>Área de risco: "+oc.area_risco);
      marcadores.push(marker);
    }
  });
  if(marcadores.length>0){map.fitBounds(L.featureGroup(marcadores).getBounds().pad(0.2));}

  // Modal
  var editModal=document.getElementById("editModal");
  var editForm=document.getElementById("editForm");
  var closeBtn=document.querySelector(".modal-close");
  document.querySelectorAll(".editBtn").forEach(btn=>{
    btn.addEventListener("click",function(){
      var tr=this.closest("tr");
      var id=tr.dataset.id;
      editForm.action="/ocorrencia/editar/"+id+"/";
      editForm.numero.value=tr.children[0].textContent;
      editForm.sigrc.value=tr.children[1].textContent;
      editForm.endereco.value=tr.children[2].textContent;
      editForm.bairro.value=tr.children[3].textContent;
      editForm.distrito.value=tr.children[4].textContent;
      editForm.area_risco.value=tr.children[5].textContent;
      editForm.motivo.value=tr.children[6].textContent;
      editForm.data.value=tr.children[7].textContent.split("/").reverse().join("-");
      editModal.style.display="flex";
    });
  });
  closeBtn.onclick=function(){editModal.style.display="none";}
  window.onclick=function(e){if(e.target==editModal){editModal.style.display="none";}}

  // Toast
  function showToast(msg){
    var toast=document.getElementById("toast");
    toast.textContent=msg;
    toast.style.display="block";
    setTimeout(()=>{toast.style.display="none";},3000);
  }

  // Paginação
  const rowsAll = Array.from(document.querySelectorAll('#ocorrenciasTable tbody tr'));
  const rowsPerPage = 10;
  let currentPage = 1;

  function displayPage(page, filter=''){
    const tbody = document.querySelector('#ocorrenciasTable tbody');
    tbody.innerHTML = '';
    const filtered = rowsAll.filter(row => row.textContent.toLowerCase().includes(filter));
    if(filtered.length===0) showToast('Nenhum resultado encontrado!');
    const start=(page-1)*rowsPerPage;
    const end=start+rowsPerPage;
    filtered.slice(start,end).forEach(row => tbody.appendChild(row));
    renderPagination(filtered.length);
  }

  function renderPagination(totalRows){
    const totalPages=Math.ceil(totalRows/rowsPerPage);
    const pagination=document.getElementById('pagination');
    pagination.innerHTML='';
    for(let i=1;i<=totalPages;i++){
      const btn=document.createElement('button');
      btn.textContent=i;
      if(i===currentPage) btn.classList.add('active');
      btn.addEventListener('click',()=>{
        currentPage=i;
        displayPage(currentPage, document.getElementById('searchInput').value.toLowerCase());
      });
      pagination.appendChild(btn);
    }
  }

  // Filtro instantâneo
  document.getElementById("searchInput").addEventListener("input",function(){
    currentPage=1;
    displayPage(currentPage, this.value.toLowerCase());
  });

  // Ordenação
  document.querySelectorAll("#ocorrenciasTable th[data-column]").forEach(th=>{
    th.addEventListener("click",function(){
      const tbody=this.closest("table").tBodies[0];
      const idx=Array.from(this.parentNode.children).indexOf(this);
      const asc=!this.asc; this.asc=asc;
      const rows=Array.from(rowsAll);
      rows.sort((a,b)=>{
        var v1=a.cells[idx].textContent.trim();
        var v2=b.cells[idx].textContent.trim();
        if(idx===7){ v1=new Date(v1.split("/").reverse().join("-")); v2=new Date(v2.split("/").reverse().join("-")); }
        return v1>v2? (asc?1:-1):(v1<v2? (asc?-1:1):0);
      });
      rows.forEach(r=>r.parentNode.appendChild(r));
      displayPage(currentPage);
    });
  });

  displayPage(currentPage);
</script>

<footer>
  <p>&copy; 2025 UNIVESP DRP14-PJI110 - GRUPO-002 PROJETO INTEGRADOR EM COMPUTAÇÃO I - TURMA 005 - Todos os direitos reservados</p>
</footer>
</body>
</html>
